<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Admin - Tengo Hambre</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <style>
    #reader {
      max-width: 320px;
      margin: 2rem auto;
    }
    .card {
      background: #fff;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin: 1rem 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #f3f3f3;
    }
    .acciones input {
      width: 60px;
    }
    .acciones button {
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <nav>
    üë©‚Äçüç≥ Tengo Hambre - Panel Admin
  </nav>

  <div class="container">
    <h2>Esc√°ner QR para recargar</h2>
    <div id="reader"></div>
    <div id="info"></div>

    <h2>Clientes</h2>
    <input type="text" id="buscador" placeholder="Buscar por nombre, tel√©fono o email">

    <table>
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Tel√©fono</th>
          <th>Email</th>
          <th>Coins</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla-clientes"></tbody>
    </table>

    <div style="text-align:center; margin-top:2rem;">
      <button onclick="logout()">Cerrar sesi√≥n</button>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('token');
    const rol = localStorage.getItem('rol');
    if (!token || rol !== 'admin') {
      alert('Acceso denegado');
      window.location.href = '/login.html';
    }

    function logout() {
      localStorage.clear();
      window.location.href = '/login.html';
    }

    let clientes = [];

    async function cargarClientes() {
      const res = await fetch('https://tengohambre-backend.onrender.com/api/clientes', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      clientes = await res.json();
      mostrarTabla(clientes);
    }

    function mostrarTabla(lista) {
      const tbody = document.getElementById('tabla-clientes');
      tbody.innerHTML = '';
      lista.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c.nombre}</td>
          <td>${c.telefono}</td>
          <td>${c.email}</td>
          <td id="coins-${c.id}">${c.hambreCoins}</td>
          <td class="acciones">
            <input type="number" id="in-${c.id}" placeholder="+" min="1">
            <button onclick="cargar('${c.id}')">‚ûï</button>
            <button onclick="eliminar('${c.id}')">üóë</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.getElementById('buscador').addEventListener('input', e => {
      const txt = e.target.value.toLowerCase();
      mostrarTabla(clientes.filter(c =>
        c.nombre.toLowerCase().includes(txt) ||
        c.telefono.includes(txt) ||
        c.email.toLowerCase().includes(txt)
      ));
    });

    async function cargar(id) {
      const monto = parseInt(document.getElementById(`in-${id}`).value);
      if (!monto || monto <= 0) return alert('Monto inv√°lido');
      await fetch(`/api/clientes/${id}/cargar`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ monto })
      });
      document.getElementById(`coins-${id}`).textContent =
        parseInt(document.getElementById(`coins-${id}`).textContent) + monto;
      document.getElementById(`in-${id}`).value = '';
    }

    async function eliminar(id) {
      if (!confirm('¬øEliminar este cliente?')) return;
      await fetch(`/api/clientes/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      cargarClientes();
    }

    // --- QR L√≥gica ---
    let qrScanner = null;
    const readerDiv = document.getElementById('reader');
    const infoDiv = document.getElementById('info');

    function iniciarEscaneo() {
      infoDiv.innerHTML = '';
      qrScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
      qrScanner.render(async (decodedText) => {
        qrScanner.clear();
        await mostrarCargaQR(decodedText);
      });
    }

    async function mostrarCargaQR(clienteId) {
      const res = await fetch(`/api/clientes/${clienteId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!res.ok) return alert('Cliente no encontrado');
      const cliente = await res.json();

      infoDiv.innerHTML = `
        <div class="card">
          <h3>${cliente.nombre}</h3>
          <p>Saldo actual: ${cliente.hambreCoins} coins</p>
          <input type="number" id="qr-monto" placeholder="Cantidad" min="1">
          <button onclick="cargarDesdeQR('${cliente.id}')">Cargar</button>
        </div>
      `;
    }

    async function cargarDesdeQR(id) {
      const monto = parseInt(document.getElementById('qr-monto').value);
      if (!monto || monto <= 0) return alert('Monto inv√°lido');
      await fetch(`/api/clientes/${id}/cargar`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ monto })
      });
      alert(`‚úÖ Se recargaron ${monto} coins`);

      // Actualiza tabla
      cargarClientes();

      // Preguntar si desea seguir escaneando
      if (confirm('¬øDese√°s escanear otro cliente?')) {
        infoDiv.innerHTML = '';
        iniciarEscaneo();
      } else {
        infoDiv.innerHTML = '<p>Escaneo finalizado. Pod√©s seguir operando desde la tabla.</p>';
      }
    }

    cargarClientes();
    iniciarEscaneo();
  </script>
</body>
</html>
